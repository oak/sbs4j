<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SerializerBuffer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dev.oak3:sbs4j</a> &gt; <a href="index.source.html" class="el_package">dev.oak3.sbs4j</a> &gt; <span class="el_source">SerializerBuffer.java</span></div><h1>SerializerBuffer.java</h1><pre class="source lang-java linenums">package dev.oak3.sbs4j;

import dev.oak3.sbs4j.exception.NoSuchTypeException;
import dev.oak3.sbs4j.exception.ValueSerializationException;
import dev.oak3.sbs4j.util.ByteUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.math.BigInteger;
import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.nio.charset.StandardCharsets;
import java.util.Arrays;

import static java.util.Objects.requireNonNull;

/**
 * Serializing methods
 *
 * @since 0.1.0
 */
public class SerializerBuffer {

<span class="fc" id="L24">    private static final Logger LOGGER = LoggerFactory.getLogger(SerializerBuffer.class);</span>

    private ByteBuffer buffer;

    private static final int INITIAL_CAPACITY = 4096;

<span class="fc" id="L30">    public static final BigInteger ZERO = new BigInteger(&quot;0&quot;, 10);</span>
<span class="fc" id="L31">    public static final BigInteger ONE = new BigInteger(&quot;1&quot;, 10);</span>
<span class="fc" id="L32">    public static final BigInteger TWO = new BigInteger(&quot;2&quot;, 10);</span>
<span class="fc" id="L33">    public static final BigInteger MAX_U64 = TWO.pow(64).subtract(ONE);</span>
<span class="fc" id="L34">    public static final BigInteger MAX_U128 = TWO.pow(128).subtract(ONE);</span>
<span class="fc" id="L35">    public static final BigInteger MAX_U256 = TWO.pow(256).subtract(ONE);</span>
<span class="fc" id="L36">    public static final BigInteger MAX_U512 = TWO.pow(512).subtract(ONE);</span>

    private static final String LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING = &quot;Writing type {} with value: {}&quot;;
    private static final String SERIALIZE_EXCEPTION_OUT_OF_BOUNDS_MESSAGE_STRING = &quot;Value %s out of bounds for expected type %s&quot;;

    /**
     * Initializes buffer with initial capacity of {@link #INITIAL_CAPACITY} in bytes and {@link ByteOrder#LITTLE_ENDIAN}
     */
    public SerializerBuffer() {
<span class="fc" id="L45">        this(INITIAL_CAPACITY, ByteOrder.LITTLE_ENDIAN);</span>
<span class="fc" id="L46">    }</span>

    /**
     * Initializes buffer with initial capacity of {@link #INITIAL_CAPACITY} and given byte order.
     *
     * @param byteOrder the byte order to be using
     */
    public SerializerBuffer(ByteOrder byteOrder) {
<span class="fc" id="L54">        this(INITIAL_CAPACITY, byteOrder);</span>
<span class="fc" id="L55">    }</span>

    /**
     * Initializes buffer with given initial capacity in bytes and byte order.
     *
     * @param initialCapacity the initial capacity of the buffer
     * @param byteOrder       the byte order to be using
     */
<span class="fc" id="L63">    public SerializerBuffer(int initialCapacity, ByteOrder byteOrder) {</span>
<span class="fc" id="L64">        this.buffer = ByteBuffer.allocate(initialCapacity);</span>
<span class="fc" id="L65">        this.buffer.order(byteOrder);</span>
<span class="fc" id="L66">        this.buffer.mark();</span>
<span class="fc" id="L67">    }</span>

    /**
     * Writes a boolean value to the value byte buffer
     *
     * @param value boolean value to serialize
     */
    public void writeBool(boolean value) {
<span class="fc" id="L75">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, Boolean.class.getSimpleName(),</span>
<span class="fc" id="L76">                value);</span>

<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        byte boolByte = Boolean.TRUE.equals(value) ? (byte) 0x01 : (byte) 0x00;</span>

<span class="fc" id="L80">        put(boolByte);</span>
<span class="fc" id="L81">    }</span>

    /**
     * Writes a single byte value
     *
     * @param value byte value to serialize
     */
    public void writeU8(byte value) {
<span class="fc" id="L89">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, Byte.class.getSimpleName(), value);</span>

<span class="fc" id="L91">        put(value);</span>
<span class="fc" id="L92">    }</span>

    /**
     * Writes a byte array value
     *
     * @param value byte array value to serialize
     */
    public void writeByteArray(byte[] value) {
<span class="fc" id="L100">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, byte[].class.getSimpleName(), value);</span>

<span class="fc" id="L102">        put(value);</span>
<span class="fc" id="L103">    }</span>

    /**
     * Writes a Float/F32 value
     *
     * @param value F32 value to serialize
     */
    public void writeF32(float value) {
<span class="fc" id="L111">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, Float.class.getSimpleName(), value);</span>

<span class="fc" id="L113">        put(value);</span>
<span class="fc" id="L114">    }</span>

    /**
     * Writes a Double/F64 value
     *
     * @param value F64 value to serialize
     */
    public void writeF64(double value) {
<span class="fc" id="L122">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, Double.class.getSimpleName(), value);</span>

<span class="fc" id="L124">        put(value);</span>
<span class="fc" id="L125">    }</span>

    /**
     * Writes an Integer/I32 value
     *
     * @param value I32 value to serialize
     */
    public void writeI32(int value) {
<span class="fc" id="L133">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, Integer.class.getSimpleName(), value);</span>

<span class="fc" id="L135">        put(value);</span>
<span class="fc" id="L136">    }</span>

    /**
     * Writes an Unsigned Integer (Long)/U32
     *
     * @param value U32 value to serialize
     */
    public void writeU32(Long value) {
<span class="fc" id="L144">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, Integer.class.getSimpleName(), value);</span>

<span class="fc" id="L146">        put(value.intValue());</span>
<span class="fc" id="L147">    }</span>

    /**
     * Writes a Long/I64 value
     *
     * @param value I64 value to serialize
     */
    public void writeI64(long value) {
<span class="fc" id="L155">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, Long.class.getSimpleName(), value);</span>

<span class="fc" id="L157">        put(value);</span>
<span class="fc" id="L158">    }</span>

    /**
     * Writes an Unsigned Long (BigInteger)/U64 to the value byte buffer
     *
     * @param value U64 value to serialize
     *              error with input/output while reading the byte array
     * @throws ValueSerializationException exception holding information of failure to serialize a value
     */
    public void writeU64(BigInteger value) throws ValueSerializationException {
<span class="fc" id="L168">        requireNonNull(value);</span>
<span class="fc" id="L169">        checkBoundsFor(value, 64);</span>

<span class="fc" id="L171">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, BigInteger.class.getSimpleName(),</span>
                value);

<span class="fc" id="L174">        put(value.longValue());</span>
<span class="fc" id="L175">    }</span>

    /**
     * Writes a BigInteger/U128 to the value byte buffer
     *
     * @param value U128 value to serialize
     *              error with input/output while reading the byte array
     * @throws ValueSerializationException exception holding information of failure to serialize a value
     */
    public void writeU128(BigInteger value) throws ValueSerializationException {
<span class="fc" id="L185">        writeBigInteger(value, 128);</span>
<span class="fc" id="L186">    }</span>

    /**
     * Writes a BigInteger/U256 to the value byte buffer
     *
     * @param value U256 value to serialize
     *              error with input/output while reading the byte array
     * @throws ValueSerializationException exception holding information of failure to serialize a value
     */
    public void writeU256(BigInteger value) throws ValueSerializationException {
<span class="fc" id="L196">        writeBigInteger(value, 256);</span>
<span class="fc" id="L197">    }</span>

    /**
     * Writes a BigInteger/U512 to the value byte buffer
     *
     * @param value U512 value to serialize
     *              error with input/output while reading the byte array
     * @throws ValueSerializationException exception holding information of failure to serialize a value
     */
    public void writeU512(BigInteger value) throws ValueSerializationException {
<span class="fc" id="L207">        writeBigInteger(value, 512);</span>
<span class="fc" id="L208">    }</span>

    /**
     * Writes a BigInteger/U128-U256-U512 to the value byte buffer
     *
     * @param value BigInteger to serialize
     * @param size  the bit size of BigInteger
     *              error with input/output while reading the byte array
     * @throws ValueSerializationException exception holding information of failure to serialize a value
     */
    protected void writeBigInteger(BigInteger value, int size) throws ValueSerializationException {
<span class="fc" id="L219">        requireNonNull(value);</span>
<span class="fc" id="L220">        checkBoundsFor(value, size);</span>

<span class="fc" id="L222">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, BigInteger.class.getSimpleName(), value);</span>

<span class="fc" id="L224">        byte bigIntegerLength = (byte) (Math.ceil(value.bitLength() / 8.0));</span>

<span class="fc" id="L226">        byte[] byteArray = value.toByteArray();</span>

<span class="fc" id="L228">        int skipped = 0;</span>
<span class="fc" id="L229">        boolean skip = true;</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">        for (byte b : byteArray) {</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">            boolean signByte = b == (byte) 0x00;</span>
<span class="fc bfc" id="L232" title="All 4 branches covered.">            if (skip &amp;&amp; signByte) {</span>
<span class="fc" id="L233">                skipped++;</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">            } else if (skip) {</span>
<span class="fc" id="L235">                skip = false;</span>
            }
        }

<span class="fc" id="L239">        byte[] bigIntegerBytes = Arrays.copyOfRange(byteArray, skipped, byteArray.length);</span>

<span class="fc bfc" id="L241" title="All 2 branches covered.">        if (this.buffer.order() == ByteOrder.LITTLE_ENDIAN) {</span>
<span class="fc" id="L242">            ByteUtils.reverse(bigIntegerBytes);</span>
        }

<span class="fc" id="L245">        put(bigIntegerLength);</span>
<span class="fc" id="L246">        put(bigIntegerBytes);</span>
<span class="fc" id="L247">    }</span>

    /**
     * Writes a String to the value byte buffer
     *
     * @param value String value to serialize
     *              error with input/output while reading the byte array
     */
    public void writeString(String value) {
<span class="fc" id="L256">        LOGGER.debug(LOG_BUFFER_WRITE_TYPE_VALUE_MESSAGE_STRING, String.class.getSimpleName(), value);</span>

<span class="fc" id="L258">        put(value.getBytes(StandardCharsets.UTF_8).length);</span>
<span class="fc" id="L259">        put(value.getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L260">    }</span>

    /**
     * Checks if the value is within valid bounds for given CLType
     *
     * @param value the value to check
     * @param size  the bit size to check against
     * @throws ValueSerializationException exception holding information of failure to serialize a value
     */
    private void checkBoundsFor(BigInteger value, int size) throws ValueSerializationException {
        BigInteger max;
<span class="fc bfc" id="L271" title="All 2 branches covered.">        if (size == 64) {</span>
<span class="fc" id="L272">            max = MAX_U64;</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">        } else if (size == 128) {</span>
<span class="fc" id="L274">            max = MAX_U128;</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">        } else if (size == 256) {</span>
<span class="fc" id="L276">            max = MAX_U256;</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">        } else if (size == 512) {</span>
<span class="fc" id="L278">            max = MAX_U512;</span>
        } else {
<span class="nc" id="L280">            throw new ValueSerializationException(&quot;Error checking numeric bounds&quot;, new NoSuchTypeException(</span>
<span class="nc" id="L281">                    String.format(&quot;%s is not a numeric size with check bounds for serializing&quot;, size)));</span>
        }

<span class="pc bpc" id="L284" title="1 of 4 branches missed.">        if (value.compareTo(max) &gt; 0 || value.compareTo(ZERO) &lt; 0) {</span>
<span class="fc" id="L285">            throw new ValueSerializationException(String.format(SERIALIZE_EXCEPTION_OUT_OF_BOUNDS_MESSAGE_STRING,</span>
<span class="fc" id="L286">                    value, size));</span>
        }
<span class="fc" id="L288">    }</span>

    /**
     * Retrieves the backing buffer
     *
     * @return the Deserializer ByteBuffer
     */
    public ByteBuffer getBuffer() {
<span class="nc" id="L296">        return this.buffer;</span>
    }

    /**
     * Gets the full byte array corresponding to serialized data
     *
     * @return the byte array serialized data
     */
    public byte[] toByteArray() {
<span class="fc" id="L305">        return Arrays.copyOfRange(this.buffer.array(),</span>
<span class="fc" id="L306">                this.buffer.arrayOffset(), this.buffer.arrayOffset() + this.buffer.position());</span>
    }

    private void put(byte newByte) {
        // check if it fits and increase buffer if needed
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">        if (this.buffer.position() + 1 &gt;= this.buffer.capacity()) {</span>
<span class="nc" id="L312">            increaseCapacity(1);</span>
        }
<span class="fc" id="L314">        this.buffer.put(newByte);</span>
<span class="fc" id="L315">    }</span>

    private void put(byte[] newBytes) {
        // check if it fits and increase buffer if needed
<span class="fc bfc" id="L319" title="All 2 branches covered.">        if (this.buffer.position() + newBytes.length &gt;= this.buffer.capacity()) {</span>
<span class="fc" id="L320">            increaseCapacity(newBytes.length);</span>
        }
<span class="fc" id="L322">        this.buffer.put(newBytes);</span>
<span class="fc" id="L323">    }</span>

    private void put(float bytes) {
        // check if it fits and increase buffer if needed
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">        if (this.buffer.position() + 4 &gt;= this.buffer.capacity()) {</span>
<span class="nc" id="L328">            increaseCapacity(4);</span>
        }
<span class="fc" id="L330">        this.buffer.putFloat(bytes);</span>
<span class="fc" id="L331">    }</span>

    private void put(double bytes) {
        // check if it fits and increase buffer if needed
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">        if (this.buffer.position() + 8 &gt;= this.buffer.capacity()) {</span>
<span class="nc" id="L336">            increaseCapacity(8);</span>
        }
<span class="fc" id="L338">        this.buffer.putDouble(bytes);</span>
<span class="fc" id="L339">    }</span>

    private void put(int bytes) {
        // check if it fits and increase buffer if needed
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">        if (this.buffer.position() + 4 &gt;= this.buffer.capacity()) {</span>
<span class="nc" id="L344">            increaseCapacity(4);</span>
        }
<span class="fc" id="L346">        this.buffer.putInt(bytes);</span>
<span class="fc" id="L347">    }</span>

    private void put(long bytes) {
        // check if it fits and increase buffer if needed
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">        if (this.buffer.position() + 8 &gt;= this.buffer.capacity()) {</span>
<span class="nc" id="L352">            increaseCapacity(8);</span>
        }
<span class="fc" id="L354">        this.buffer.putLong(bytes);</span>
<span class="fc" id="L355">    }</span>

    /**
     * Increases the buffer size and replaces with the new capacity buffer including current buffer data
     *
     * @param increaseByteCount the byte count to increase
     * @throws IllegalArgumentException if the parameter is invalid
     */
    protected void increaseCapacity(int increaseByteCount) throws IllegalArgumentException {
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">        if (this.buffer == null) {</span>
<span class="nc" id="L365">            throw new IllegalArgumentException(&quot;Buffer is null&quot;);</span>
        }

<span class="pc bpc" id="L368" title="1 of 2 branches missed.">        if (increaseByteCount &lt; 0) {</span>
<span class="nc" id="L369">            throw new IllegalArgumentException(&quot;Size cannot be less than 0&quot;);</span>
        }

<span class="fc" id="L372">        int newCapacity = this.buffer.capacity() + increaseByteCount;</span>
<span class="fc" id="L373">        ByteBuffer newBuffer = ByteBuffer.allocate(newCapacity);</span>
<span class="fc" id="L374">        this.buffer.flip();</span>
<span class="fc" id="L375">        newBuffer.order(this.buffer.order());</span>
<span class="fc" id="L376">        newBuffer.put(this.buffer);</span>
<span class="fc" id="L377">        this.buffer = newBuffer;</span>
<span class="fc" id="L378">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>