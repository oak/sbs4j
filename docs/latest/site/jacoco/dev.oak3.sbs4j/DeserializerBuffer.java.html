<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeserializerBuffer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dev.oak3:sbs4j</a> &gt; <a href="index.source.html" class="el_package">dev.oak3.sbs4j</a> &gt; <span class="el_source">DeserializerBuffer.java</span></div><h1>DeserializerBuffer.java</h1><pre class="source lang-java linenums">package dev.oak3.sbs4j;

import dev.oak3.sbs4j.exception.ValueDeserializationException;
import dev.oak3.sbs4j.util.ByteUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.math.BigInteger;
import java.nio.BufferUnderflowException;
import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.util.Arrays;

/**
 * Deserializing methods
 *
 * @since 0.1.0
 */
public class DeserializerBuffer {

    private final ByteBuffer buffer;

<span class="fc" id="L23">    private static final Logger LOGGER = LoggerFactory.getLogger(DeserializerBuffer.class);</span>

    private static final String LOG_BUFFER_INIT_MESSAGE_HEX_STRING = &quot;Initializing DeserializerBuffer with hexString: {} and byte order {}&quot;;
    private static final String LOG_BUFFER_INIT_MESSAGE = &quot;Initializing DeserializerBuffer with bytes: {} and byte order {}&quot;;
    private static final String LOG_BUFFER_VALUE_MESSAGE_STRING = &quot;Buffer value: {}&quot;;
    private static final String LOG_SERIALIZED_VALUE_MESSAGE_STRING = &quot;Deserialized value for {}: {}&quot;;
    private static final String SERIALIZE_EXCEPTION_OUT_OF_BOUNDS_MESSAGE_STRING = &quot;Value %s out of bounds for expected type %s&quot;;

    /**
     * Initializes buffer with serialized bytes from hex-encoded {@link String}
     *
     * @param hexString hex-encoded {@link String} to deserialize and read from
     */
    public DeserializerBuffer(String hexString) {
<span class="fc bfc" id="L37" title="All 2 branches covered.">        this(hexString.length() != 0 ? ByteUtils.parseHexString(hexString) : new byte[]{});</span>
<span class="fc" id="L38">    }</span>

    /**
     * Initializes buffer with serialized bytes from hex-encoded {@link String}
     *
     * @param hexString hex-encoded {@link String} to deserialize and read from
     * @param byteOrder the byte order to be using
     */
    public DeserializerBuffer(String hexString, ByteOrder byteOrder) {
<span class="nc bnc" id="L47" title="All 2 branches missed.">        this(hexString.length() != 0 ? ByteUtils.parseHexString(hexString) : new byte[]{}, byteOrder);</span>

<span class="nc" id="L49">        LOGGER.debug(LOG_BUFFER_INIT_MESSAGE_HEX_STRING, hexString, byteOrder);</span>
<span class="nc" id="L50">    }</span>

    /**
     * Initializes buffer with serialized bytes and {@link ByteOrder#LITTLE_ENDIAN}
     *
     * @param bytes byte array to deserialize and read from
     */
    public DeserializerBuffer(byte[] bytes) {
<span class="fc" id="L58">        this(bytes, ByteOrder.LITTLE_ENDIAN);</span>
<span class="fc" id="L59">    }</span>

    /**
     * Initializes buffer with serialized bytes and byte order
     *
     * @param bytes     byte array to deserialize and read from
     * @param byteOrder the byte order to be using
     */
<span class="fc" id="L67">    public DeserializerBuffer(byte[] bytes, ByteOrder byteOrder) {</span>
<span class="fc" id="L68">        this.buffer = ByteBuffer.wrap(bytes);</span>
<span class="fc" id="L69">        this.buffer.order(byteOrder);</span>
<span class="fc" id="L70">        this.buffer.mark();</span>

<span class="fc" id="L72">        LOGGER.debug(LOG_BUFFER_INIT_MESSAGE, Arrays.toString(bytes), byteOrder);</span>
<span class="fc" id="L73">    }</span>

    /**
     * Reads a Boolean value
     *
     * @return true if 1, while false if 0
     * @throws ValueDeserializationException exception holding information of failure to deserialize a value
     */
    public Boolean readBool() throws ValueDeserializationException {
        try {
<span class="fc" id="L83">            byte buf = this.buffer.get();</span>

<span class="fc" id="L85">            LOGGER.debug(LOG_BUFFER_VALUE_MESSAGE_STRING, buf);</span>

<span class="pc bpc" id="L87" title="1 of 2 branches missed.">            if (buf == 1) {</span>
<span class="fc" id="L88">                return true;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">            } else if (buf == 0) {</span>
<span class="nc" id="L90">                return false;</span>
            } else {
<span class="nc" id="L92">                throw new ValueDeserializationException(</span>
<span class="nc" id="L93">                        String.format(SERIALIZE_EXCEPTION_OUT_OF_BOUNDS_MESSAGE_STRING, buf, Boolean.class.getSimpleName()));</span>
            }
<span class="fc" id="L95">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="fc" id="L96">            throw new ValueDeserializationException(&quot;Error while reading boolean from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads a byte from buffer
     *
     * @return the byte
     */
    public byte readU8() throws ValueDeserializationException {
        try {
<span class="fc" id="L107">            byte u8 = this.buffer.get();</span>

<span class="fc" id="L109">            LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, Byte.class.getSimpleName(), u8);</span>

<span class="fc" id="L111">            return u8;</span>
<span class="nc" id="L112">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="nc" id="L113">            throw new ValueDeserializationException(&quot;Error while reading U8 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads a byte[] from buffer
     *
     * @param length the length of the array
     * @return the byte array as byte[]
     */
    public byte[] readByteArray(int length) throws ValueDeserializationException {
        try {
<span class="fc" id="L125">            byte[] bytes = readBytes(length);</span>

<span class="fc" id="L127">            LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, Byte.class.getSimpleName(), bytes);</span>

<span class="fc" id="L129">            return bytes;</span>
<span class="fc" id="L130">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="fc" id="L131">            throw new ValueDeserializationException(&quot;Error while reading byte array from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads a float of 32 bits (4 bytes)
     *
     * @return the number as a float
     */
    public float readF32() throws ValueDeserializationException {
        try {
<span class="fc" id="L142">            float floatNumber = this.buffer.getFloat();</span>

<span class="fc" id="L144">            LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, Float.class.getSimpleName(), floatNumber);</span>

<span class="fc" id="L146">            return floatNumber;</span>
<span class="nc" id="L147">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="nc" id="L148">            throw new ValueDeserializationException(&quot;Error while reading F32 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads a float of 64 bits (8 bytes)
     *
     * @return the number as a double
     */
    public double readF64() throws ValueDeserializationException {
        try {
<span class="fc" id="L159">            double doubleNumber = this.buffer.getDouble();</span>

<span class="fc" id="L161">            LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, Double.class.getSimpleName(), doubleNumber);</span>

<span class="fc" id="L163">            return doubleNumber;</span>
<span class="nc" id="L164">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="nc" id="L165">            throw new ValueDeserializationException(&quot;Error while reading F64 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads a signed int of 32 bits (4 bytes)
     *
     * @return the number as an int
     */
    public int readI32() throws ValueDeserializationException {
        try {
<span class="fc" id="L176">            int integerNumber = this.buffer.getInt();</span>

<span class="fc" id="L178">            LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, Long.class.getSimpleName(), integerNumber);</span>

<span class="fc" id="L180">            return integerNumber;</span>
<span class="nc" id="L181">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="nc" id="L182">            throw new ValueDeserializationException(&quot;Error while reading I32 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads an unsigned int of 32 bits (4 bytes)
     *
     * @return the number as a long
     */
    public long readU32() throws ValueDeserializationException {
        try {
<span class="fc" id="L193">            int signedInteger = this.buffer.getInt();</span>
<span class="fc" id="L194">            long unsignedIntegerLong = Integer.toUnsignedLong(signedInteger);</span>

<span class="fc" id="L196">            LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, Long.class.getSimpleName(), unsignedIntegerLong);</span>
<span class="fc" id="L197">            return unsignedIntegerLong;</span>
<span class="fc" id="L198">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="fc" id="L199">            throw new ValueDeserializationException(&quot;Error while reading U32 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads a signed int of 64 bits (8 bytes)
     *
     * @return the number as a long
     */
    public long readI64() throws ValueDeserializationException {
        try {
<span class="fc" id="L210">            long longNumber = this.buffer.getLong();</span>

<span class="fc" id="L212">            LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, Long.class.getSimpleName(), longNumber);</span>

<span class="fc" id="L214">            return longNumber;</span>
<span class="nc" id="L215">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="nc" id="L216">            throw new ValueDeserializationException(&quot;Error while reading I64 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads an unsigned int of 64 bits (8 bytes)
     *
     * @return the number as a BigInteger
     */
    public BigInteger readU64() throws ValueDeserializationException {
        try {
            // Since this is a positive (unsigned) number, we should prefix with a zero
            // byte to parse correctly
<span class="fc" id="L229">            ByteBuffer bb = ByteBuffer.allocate(9);</span>
<span class="fc" id="L230">            bb.put((byte) 0);</span>
<span class="fc" id="L231">            bb.putLong(this.buffer.getLong());</span>
<span class="fc" id="L232">            BigInteger unsignedLong = new BigInteger(bb.array());</span>

<span class="fc" id="L234">            LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, BigInteger.class.getSimpleName(), unsignedLong);</span>

<span class="fc" id="L236">            return unsignedLong;</span>
<span class="fc" id="L237">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="fc" id="L238">            throw new ValueDeserializationException(&quot;Error while reading U64 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads an unsigned int of 128 bits (16 bytes) max
     *
     * @return the number as a BigInteger
     */
    public BigInteger readU128() throws ValueDeserializationException {
        try {
<span class="fc" id="L249">            return this.readBigInteger();</span>
<span class="fc" id="L250">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="fc" id="L251">            throw new ValueDeserializationException(&quot;Error while reading U128 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads U256 from buffer
     *
     * @return the number as a BigInteger
     */
    public BigInteger readU256() throws ValueDeserializationException {
        try {
<span class="fc" id="L262">            return this.readBigInteger();</span>
<span class="fc" id="L263">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="fc" id="L264">            throw new ValueDeserializationException(&quot;Error while reading U256 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Reads U512 from buffer
     *
     * @return the number as a BigInteger
     */
    public BigInteger readU512() throws ValueDeserializationException {
        try {
<span class="fc" id="L275">            return this.readBigInteger();</span>
<span class="fc" id="L276">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="fc" id="L277">            throw new ValueDeserializationException(&quot;Error while reading U512 from buffer&quot;, bufferUnderflowException);</span>
        }
    }

    /**
     * Larger numeric values (e.g., U128, U256, U512) serialize as one byte of the
     * length of the next number, followed by the two’s complement representation
     * with little-endian byte order.
     *
     * @return the number as a BigInteger
     */
    protected BigInteger readBigInteger() {
<span class="fc" id="L289">        byte lengthOfNextNumber = this.buffer.get();</span>

<span class="fc" id="L291">        LOGGER.debug(&quot;Length of next number: {}&quot;, lengthOfNextNumber);</span>

<span class="fc" id="L293">        byte[] buf = new byte[lengthOfNextNumber + 1];</span>

<span class="fc" id="L295">        this.buffer.get(buf, 1, lengthOfNextNumber);</span>

<span class="fc" id="L297">        LOGGER.debug(LOG_BUFFER_VALUE_MESSAGE_STRING, buf);</span>

<span class="fc bfc" id="L299" title="All 2 branches covered.">        if (this.buffer.order() == ByteOrder.LITTLE_ENDIAN) {</span>
<span class="fc" id="L300">            ByteUtils.reverse(buf, 1, buf.length - 1);</span>
        }

<span class="fc" id="L303">        BigInteger bigInt = new BigInteger(buf);</span>

<span class="fc" id="L305">        LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, BigInteger.class.getSimpleName(), bigInt);</span>

<span class="fc" id="L307">        return bigInt;</span>
    }

    /**
     * Reads a String value from buffer
     *
     * @return the String read
     */
    public String readString() throws ValueDeserializationException {
        try {
<span class="fc" id="L317">            int length = this.buffer.getInt();</span>

<span class="fc" id="L319">            LOGGER.debug(&quot;Reading string of length: {}&quot;, length);</span>

<span class="fc" id="L321">            byte[] bufString = new byte[length];</span>

<span class="fc" id="L323">            this.buffer.get(bufString, 0, length);</span>

<span class="fc" id="L325">            LOGGER.debug(LOG_BUFFER_VALUE_MESSAGE_STRING, bufString);</span>

<span class="fc" id="L327">            String string = new String(bufString);</span>

<span class="fc" id="L329">            LOGGER.debug(LOG_SERIALIZED_VALUE_MESSAGE_STRING, String.class.getSimpleName(), string);</span>

<span class="fc" id="L331">            return string;</span>
<span class="fc" id="L332">        } catch (BufferUnderflowException bufferUnderflowException) {</span>
<span class="fc" id="L333">            throw new ValueDeserializationException(&quot;Error while reading String from buffer&quot;, bufferUnderflowException);</span>
        }

    }

    /**
     * Retrieves the backing buffer
     *
     * @return the Deserializer ByteBuffer
     */
    public ByteBuffer getBuffer() {
<span class="nc" id="L344">        return this.buffer;</span>
    }

    /**
     * Reads a specified number of bytes
     *
     * @param length the number of bytes to read
     * @return bytes read
     */
    protected byte[] readBytes(int length) {
<span class="fc" id="L354">        byte[] buf = new byte[length];</span>

<span class="fc" id="L356">        this.buffer.get(buf, 0, length);</span>

<span class="fc" id="L358">        LOGGER.debug(LOG_BUFFER_VALUE_MESSAGE_STRING, buf);</span>

<span class="fc" id="L360">        return buf;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>